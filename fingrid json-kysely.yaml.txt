# Fingrid application/json-kysely => configuration.yaml
  # Tarvitset oman api-keyn lue ohjeet: https://developer-data.fingrid.fi/ käytä saamaasi api-keytä kohdassa x-api-key: !secret fingrid_api_key
  # Tässä käytettävät reaaliaikaiset (päivittyvät Fingridillä 3 tai 15 minuutin välein) tietoaineistot löytyvät: https://developer-data.fingrid.fi/api-details#api=avoindata-api&operation=GetDatasetShorts
  # Huom! Tuotantomuodoista ei vielä löydy Fingridin rajapinnasta reaaliaikaista Aurinkovoiman tuotantoa, tämä puuttuu tästä johdosta.

rest:
  - resource_template: >
      {% set now_utc = utcnow() %}
      {% set now_minus_90 = now_utc - timedelta(minutes=90) %}
      {% set start_time = now_minus_90.strftime('%Y-%m-%dT%H:%M:%SZ') %}
      https://data.fingrid.fi/api/data?datasets=60,61,90,55,75,183,57,188,74,124,194,58,201,202,205,209,191&startTime={{ start_time }}&pageSize=1000&sortBy=startTime    
    headers:
      x-api-key: !secret fingrid_api
    scan_interval: 180
    sensor:
      - name: "Rajasiirto Pohjois-Ruotsi"
        unique_id: fingrid_1
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 60) | map(attribute='value') | first %}
          {% if value_json < 0 %}
          Import {{ value_json | round(0) }} MW →
          {% else %}
          ← Export {{ value_json | round(0) }} MW
          {% endif %}

      - name: "Rajasiirto Keski-Ruotsi"
        unique_id: fingrid_2
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 61) | map(attribute='value') | first %}
          {% if value_json < 0 %}
          Import {{ value_json | round(0) }} MW →
          {% else %}
          ← Export {{ value_json | round(0) }} MW
          {% endif %}

      - name: "Rajasiirto Ahvenanmaa"
        unique_id: fingrid_3
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 90) | map(attribute='value') | first %}
          {% if value_json < 0 %}
          Import {{ value_json | round(0) }} MW →
          {% else %}
          ← Export {{ value_json | round(0) }} MW
          {% endif %}

      - name: "Rajasiirto Viroon"
        unique_id: fingrid_4
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 55) | map(attribute='value') | first %}
          {% if value_json < 0 %}
          Import {{ value_json | round(0) }} MW →
          {% else %}
          ← Export {{ value_json | round(0) }} MW
          {% endif %}

      - name: "Rajasiirto Norja"
        unique_id: fingrid_5
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 57) | map(attribute='value') | first %}
          {% if value_json < 0 %}
          Import {{ value_json | round(0) }} MW →
          {% else %}
          ← Export {{ value_json | round(0) }} MW
          {% endif %}

      - name: "Rajasiirto Venäjä"
        unique_id: fingrid_6
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 58) | map(attribute='value') | first %}
          {% if value_json < 0 %}
          Import {{ value_json | round(0) }} MW →
          {% else %}
          ← Export {{ value_json | round(0) }} MW
          {% endif %}

      - name: "Tuulivoima tuotanto"
        unique_id: fingrid_7
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 75) | map(attribute='value') | first }}"

      - name: "Tehoreservi"
        unique_id: fingrid_8
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 183) | map(attribute='value') | first }}"

      - name: "Ydinvoima"
        unique_id: fingrid_9
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 188) | map(attribute='value') | first }}"

      - name: "Tuotanto Suomessa"
        unique_id: fingrid_10
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 74) | map(attribute='value') | first }}"

      - name: "Kulutus Suomessa"
        unique_id: fingrid_11
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 124) | map(attribute='value') | first }}"

      - name: "Tuonti vienti netto"
        unique_id: fingrid_12
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 194) | map(attribute='value') | first }}"

      - name: "Yhteistuotanto kaukolämpö"
        unique_id: fingrid_13
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 201) | map(attribute='value') | first }}"

      - name: "Yhteistuotanto teollisuus"
        unique_id: fingrid_14
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 202) | map(attribute='value') | first }}"

      - name: "Muu tuotanto"
        unique_id: fingrid_15
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 205) | map(attribute='value') | first }}"

      - name: "Vesivoima"
        unique_id: fingrid_16
        icon: mdi:transmission-tower
        unit_of_measurement: 'MW'
        json_attributes_path: $.data
        value_template: "{{ value_json.data | selectattr('datasetId', 'eq', 191) | map(attribute='value') | first }}"

      - name: "Voimajärjestelmän käyttötilanne"
        unique_id: fingrid_17
        icon: mdi:transmission-tower
        json_attributes_path: $.data
        value_template: >-
          {% set value_json = value_json.data | selectattr('datasetId', 'eq', 209) | map(attribute='value') | first %}
          {% set mapper =  {
            1 : 'Normal',
            2 : 'Degraded',
            3 : 'At risk',
            4 : 'Severe disturbance',
            5 : 'Severe disturbance (reversal)' } %}
          {% set state =  value_json %}
          {{ mapper[state] if state in mapper else 'Not known' }}
